<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Negocios ‚Äî Mapa por Sector (Pachac√°mac)</title>
  <style>
    :root{
      --brand:#1a73e8; --ink:#0f172a; --muted:#667085; --bg:#f6f7f9; --card:#ffffff; --ring:#e5e7eb; --chip:#0f172a0f;
      --export-h:56px; --fab-gap:16px;
    }
    [data-theme="dark"]{
      --brand:#60a5fa; --ink:#e5e7eb; --muted:#9aa4b2; --bg:#0b1220; --card:#0f172a; --ring:#1f2937; --chip:#0b1324;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,system-ui,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      transition: background .25s, color .25s;
    }
    .hero{
      position:sticky; top:0; z-index:20;
      background: radial-gradient(1200px 600px at 10% -20%, rgba(232,240,254,.6) 10%, transparent 60%), var(--card);
      border-bottom:1px solid var(--ring); padding:16px 12px 10px;
      display:flex; flex-direction:column; gap:8px; align-items:center; text-align:center;
    }
    [data-theme="dark"] .hero{ background: radial-gradient(1200px 600px at 10% -20%, rgba(37,99,235,.25) 8%, transparent 60%), var(--card); }
    .hero h1{margin:0; font-size:20px; font-weight:800; color:var(--brand)}
    .hero p{margin:0; color:var(--muted); font-size:13px}
    .top-actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
    .btn{
      padding:9px 12px; border-radius:10px; border:1px solid var(--ring); background:#fff; cursor:pointer;
      font-weight:600; color:#111827; text-decoration:none; display:inline-flex; align-items:center; gap:6px;
      transition: box-shadow .25s, transform .08s, background .25s, color .25s, border-color .25s;
    }
    .btn.primary{background:var(--brand); color:#fff; border-color:var(--brand)}
    .btn:hover{box-shadow:0 8px 22px rgba(0,0,0,.10)} .btn:active{transform:translateY(1px)}
    [data-theme="dark"] .btn{ background:#0b1324; color:#e5e7eb; border-color:#223049 }

    .controls{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background:rgba(255,255,255,.75); backdrop-filter: blur(8px);
      padding:10px 14px; margin:8px 12px; border:1px solid var(--ring);
      border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.06);
      transition: background .25s;
    }
    [data-theme="dark"] .controls{ background:rgba(15,23,42,.75) }
    .controls .group{display:flex; gap:8px; align-items:center}
    label{font-weight:600; color:#334155; font-size:14px}
    [data-theme="dark"] label{color:#cbd5e1}
    select,input{
      padding:9px 12px; border:1px solid var(--ring); border-radius:10px; background:#fff; color:#111827;
      transition:border-color .2s, box-shadow .2s, transform .08s, background .25s, color .25s;
    }
    [data-theme="dark"] select,[data-theme="dark"] input{background:#0b1324;color:#e5e7eb;border-color:#223049}
    select:focus,input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(26,115,232,.18)}
    .search{min-width:240px}

    .stats{display:flex; gap:10px; align-items:center; padding:0 14px 8px 14px}
    .chip{display:inline-flex; gap:6px; align-items:center; background:var(--chip); border:1px solid var(--ring);
      color:#1f2937; padding:6px 10px; border-radius:999px; font-size:13px}
    [data-theme="dark"] .chip{ color:#e5e7eb }

    #map{height:62vh; min-height:520px; width:100%; border-top:1px solid var(--ring); border-bottom:1px solid var(--ring)}

    .export{
      position:sticky; bottom:0; z-index:15;
      background:linear-gradient(180deg, rgba(246,247,249,.9), rgba(255,255,255,.95));
      backdrop-filter: blur(6px); border-top:1px solid var(--ring);
      padding:10px 14px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; min-height:48px;
    }
    [data-theme="dark"] .export{ background:linear-gradient(180deg, rgba(11,18,32,.85), rgba(15,23,42,.95)); }

    .fab-panel{position:fixed; right:16px; bottom:calc(var(--export-h) + var(--fab-gap)); display:flex; flex-direction:column; gap:8px; z-index:9000; width:min(460px, 92vw)}
    .fab{background:#fff; border:1px solid var(--ring); border-radius:10px; padding:8px 10px; font-weight:600; cursor:pointer}
    [data-theme="dark"] .fab{ background:#0b1324; color:#e5e7eb; border-color:#223049 }
    .fab:focus{outline:none; box-shadow:0 0 0 3px rgba(26,115,232,.18)}
    #personSelect{max-height:360px; overflow:auto}

    .toast{position:fixed; right:16px; top:16px; z-index:9999; background:#0ea5e9; color:#fff; border-radius:12px; padding:10px 14px; font-size:13px; opacity:0; transform:translateY(-8px); transition:.25s}
    .toast.show{opacity:1; transform:none}

    /* InfoWindow dark */
    [data-theme="dark"] .gm-style .gm-style-iw-c{ background:#0b1324 !important; color:#e5e7eb !important; border-radius:12px }
    [data-theme="dark"] .gm-style .gm-style-iw-d{ color:#e5e7eb !important }
    [data-theme="dark"] .gm-style .gm-style-iw-t::after{ background:#0b1324 !important }

    @media (max-width:640px){
      .controls{ margin:8px } .stats{ padding:0 8px 8px }
    }
  </style>
</head>
<body>
  <div class="hero">
    <h1>üìç Negocios ‚Äî Mapa por Sector</h1>
    <p>Distrito de <b>Pachac√°mac</b> ‚Äî columnas oficiales (sin turno)</p>
    <div class="top-actions">
      <a class="btn" href="index.html">‚Ü©Ô∏è Ir al mapa principal</a>
      <button id="themeToggle" class="btn"><span id="themeIcon">üåô</span> <span id="themeText">Modo oscuro</span></button>
    </div>
  </div>

  <div class="controls">
    <div class="group">
      <label>üèòÔ∏è Sector</label>
      <select id="sectorFilter"><option value="todos">Todos</option></select>
    </div>
    <div class="group">
      <label>üóìÔ∏è A√±o</label>
      <select id="yearFilter"><option value="todos">Todos</option></select>
    </div>
    <div class="group" style="flex:1;min-width:240px">
      <label>üîé Buscar</label>
      <input id="searchInput" class="search" placeholder="Nombre comercial, titular, giro, direcci√≥n‚Ä¶"/>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px">
      <button id="toggleEdit" class="btn">‚úèÔ∏è Modo edici√≥n</button>
    </div>
  </div>

  <div class="stats">
    <span class="chip">üóÇÔ∏è Sectores: <b id="sectorCount">0</b></span>
    <span class="chip">üìÖ A√±os activos: <b id="yearCount">0</b></span>
    <span class="chip">üìç Mostrando: <b id="visibleCount">0</b></span>
    <span class="chip">üë• Total: <b id="totalCount">0</b></span>
  </div>

  <div id="map"></div>

  <!-- Panel de edici√≥n -->
  <div class="fab-panel" id="editPanel" style="display:none">
    <input id="editorFilter" class="fab" placeholder="Filtrar por Licencia o Nombre‚Ä¶ (Enter para licencia exacta)"/>
    <select id="personSelect" class="fab" title="Selecciona negocio‚Ä¶">
      <option value="">Selecciona negocio‚Ä¶</option>
    </select>
    <button id="btnAssign" class="fab">üìå Asignar en el mapa</button>
    <button id="btnCenter" class="fab">üéØ Centrar</button>
    <button id="btnClear" class="fab">üóëÔ∏è Quitar ubicaci√≥n</button>
    <div class="fab" id="coordPreview">Lat: ‚Äî , Lng: ‚Äî</div>
    <button id="btnExportXlsx" class="fab">üíæ Descargar Excel actualizado</button>
    <button id="btnExportCsv" class="fab">‚¨áÔ∏è Descargar CSV actualizado</button>
  </div>

  <div class="export" id="exportBar">
    <label><input type="checkbox" id="onlyVisible"> Exportar solo visibles</label>
    <button id="btnKml" class="btn">‚¨áÔ∏è Descargar KML</button>
    <button id="btnKmz" class="btn primary">‚¨áÔ∏è Descargar KMZ</button>
    <div style="flex:1"></div>
  </div>

  <div id="toast" class="toast">Cargando‚Ä¶</div>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    /* ===== Config ===== */
    const DATA_CANDIDATES = ["negocios66.xlsx","negocios.csv"];
    const MAP_ID_LIGHT = "TU_MAP_ID_CLARO";
    const MAP_ID_DARK  = "TU_MAP_ID_OSCURO";
    const CENTER = { lat: -12.155, lng: -76.870 };

    /* ===== Estado ===== */
    let map, infoWindow, markers=[];
    let allData=[];
    let editMode=false, assignMode=false, mapClickListener=null, selectedId="";
    let lastEditorFilter = "";

    /* ===== Utils ===== */
    const normalizeKey = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim().replace(/\s+/g,'_');
    const esc = t => String(t??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const theme = () => document.documentElement.getAttribute('data-theme') || 'light';
    const strokeForTheme = () => theme()==='dark' ? '#cbd5e1' : '#111827';
    function toast(msg, ok=true){ const el=document.getElementById('toast'); el.textContent=msg; el.style.background=ok?'#0ea5e9':'#ef4444'; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 2200); }
    function adjustFabOffset(){ const h=(document.getElementById('exportBar')?.offsetHeight||56); document.documentElement.style.setProperty('--export-h', h+'px'); }
    const parseUbicacion = v => { if(!v) return {lat:null,lng:null}; const t=String(v).replace(/\s+/g,''); const [la,ln]=t.split(','); const lat=parseFloat(la), lng=parseFloat(ln); return {lat:Number.isFinite(lat)?lat:null, lng:Number.isFinite(lng)?lng:null}; };

    /* === helpers de columnas === */
    const findKey = (obj, tokens) => {
      const keys = Object.keys(obj);
      const ok = k => tokens.every(t => k.includes(t));
      return keys.find(k => ok(k)) || '';
    };
    const pick = (obj, keys, tokens=[]) => {
      for(const k of keys){ if(obj[k] != null) return obj[k]; }
      if(tokens.length){ const fk = findKey(obj, tokens); if(fk) return obj[fk]; }
      return '';
    };

    /* ===== A√ëO: parse + colores ===== */
    const parseYear = (val) => {
      const m = String(val||'').match(/(19|20)\d{2}/);
      const y = m ? parseInt(m[0],10) : null;
      return (y && y>=1990 && y<=2100) ? y : null;
    };

    const PALETTE_HEX = [
      '#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6','#eab308','#3b82f6',
      '#f97316','#22c55e','#d946ef','#06b6d4','#dc2626','#84cc16','#0ea5e9','#fb7185',
      '#65a30d','#9333ea','#0284c7','#ca8a04'
    ];
    let YEAR_COLOR_MAP = {};
    const colorForYear = (y) => YEAR_COLOR_MAP[String(y)] || '#94a3b8'; // gris para sin a√±o
    function buildYearColorMap(years){
      YEAR_COLOR_MAP = {};
      years.forEach((y,i)=>{ YEAR_COLOR_MAP[String(y)] = PALETTE_HEX[i % PALETTE_HEX.length]; });
    }

    const displayName = a => (a.nombre_comercial || a.titular || '').trim();

    /* ===== Map ===== */
    function svgIcon(fill, stroke){
      const svg=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
        <circle cx="14" cy="14" r="11" fill="${fill}" />
        <circle cx="14" cy="14" r="12.5" fill="none" stroke="${stroke}" stroke-width="3" />
      </svg>`;
      return { url:'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(svg), scaledSize:new google.maps.Size(28,28), anchor:new google.maps.Point(14,14) };
    }
    function popupHtml(a){
      return `
        <div style="min-width:260px;max-width:380px;font-family:inherit">
          <div style="background:#1a73e8;color:#fff;padding:10px;border-radius:6px 6px 0 0;margin:-8px -8px 8px -8px;font-weight:700">
            ${esc(displayName(a) || a.licencia || '‚Äî')}
          </div>
          <div><b>A√±o:</b> ${a.anio ?? '-'}</div>
          <div><b>Licencia:</b> ${esc(a.licencia||'-')}</div>
          <div><b>Periodo:</b> ${esc(a.periodo||'-')}</div>
          <div><b>Titular / Raz√≥n social:</b> ${esc(a.titular||'-')}</div>
          <div><b>RUC:</b> ${esc(a.ruc||'-')}</div>
          <div><b>Direcci√≥n:</b> ${esc(a.dir||'-')} ${a.num?('N¬∞ '+esc(a.num)) : ''} ${a.mz?(' MZ. '+esc(a.mz)) : ''} ${a.lt?(' LT. '+esc(a.lt)) : ''}</div>
          <div><b>Sector:</b> ${esc(a.sector||'-')}</div>
          <div><b>Giro:</b> ${esc(a.giro||'-')}</div>
        </div>`;
    }
    function clearMarkers(){ for(const m of markers) m.setMap && m.setMap(null); markers=[]; }
    function renderMarkers(data){
      clearMarkers();
      const bounds=new google.maps.LatLngBounds();
      const hasAdv=!!(google.maps.marker && google.maps.marker.AdvancedMarkerElement);
      const ring=strokeForTheme();
      data.forEach(a=>{
        if(!Number.isFinite(a.lat)||!Number.isFinite(a.lng)) return;
        const pos={lat:a.lat,lng:a.lng};
        const fill=colorForYear(a.anio);
        if(hasAdv){
          const node=document.createElement('div');
          node.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
            <circle cx="14" cy="14" r="11" fill="${fill}" />
            <circle cx="14" cy="14" r="12.5" fill="none" stroke="${ring}" stroke-width="3" />
          </svg>`;
          const mk=new google.maps.marker.AdvancedMarkerElement({map,position:pos,title:displayName(a)||a.licencia,content:node});
          mk.addListener('gmp-click',()=>{ infoWindow.setContent(popupHtml(a)); infoWindow.open({anchor:mk,map}); });
          markers.push(mk); bounds.extend(mk.position);
        }else{
          const mk=new google.maps.Marker({map,position:pos,title:displayName(a)||a.licencia,icon:svgIcon(fill,ring)});
          mk.addListener('click',()=>{ infoWindow.setContent(popupHtml(a)); infoWindow.open({anchor:mk,map}); });
          markers.push(mk); bounds.extend(mk.getPosition());
        }
      });
      if(data.some(a=>Number.isFinite(a.lat)&&Number.isFinite(a.lng))) map.fitBounds(bounds, 60); else { map.setCenter(CENTER); map.setZoom(13); }
    }

    /* ===== Filtros ===== */
    const currentSector = () => document.getElementById('sectorFilter').value;
    const currentYear = () => document.getElementById('yearFilter').value;

    function applyFilters(){
      const sector=currentSector();
      const year=currentYear();
      const q=document.getElementById('searchInput').value.trim().toLowerCase();
      return allData.filter(a=>{
        const sOk = (sector==='todos') || (String(a.sector).toLowerCase()===String(sector).toLowerCase());
        const yOk = (year==='todos') || (String(a.anio)===String(year));
        const qOk = !q || [a.nombre_comercial,a.titular,a.giro,a.dir,a.sector,a.licencia,a.periodo]
          .some(v=>String(v||'').toLowerCase().includes(q));
        return sOk && yOk && qOk;
      });
    }
    function updateStats(filtered){
      const sectores=[...new Set(allData.map(a=>a.sector).filter(Boolean))];
      const years=[...new Set(allData.map(a=>a.anio).filter(Boolean))];
      document.getElementById('sectorCount').textContent=sectores.length;
      document.getElementById('yearCount').textContent=years.length;
      document.getElementById('visibleCount').textContent=filtered.filter(a=>Number.isFinite(a.lat)&&Number.isFinite(a.lng)).length;
      document.getElementById('totalCount').textContent=allData.length;
    }
    function populateFilters(){
      const sectores=[...new Set(allData.map(a=>a.sector).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
      const sel=document.getElementById('sectorFilter'); sel.innerHTML='<option value="todos">Todos</option>';
      sectores.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });

      const years=[...new Set(allData.map(a=>a.anio).filter(Boolean))].sort((a,b)=>a-b); // asc
      buildYearColorMap(years);
      const ysel=document.getElementById('yearFilter'); ysel.innerHTML='<option value="todos">Todos</option>';
      years.forEach(y=>{ const o=document.createElement('option'); o.value=y; o.textContent=y; ysel.appendChild(o); });
    }
    function refresh(){
      const f=applyFilters();
      renderMarkers(f);
      updateStats(f);
      if (editMode) rebuildPersonSelect(lastEditorFilter); // respeta sector y a√±o
    }

    /* ===== Carga datos ===== */
    async function loadFromUrl(name){
      const resp=await fetch(name); if(!resp.ok) throw new Error('No se pudo cargar '+name);
      const low=name.toLowerCase();
      if(low.endsWith('.xlsx')||low.endsWith('.xls')){
        const wb=XLSX.read(await resp.arrayBuffer(),{type:'array'}); const sh=wb.Sheets[wb.SheetNames[0]];
        return XLSX.utils.sheet_to_json(sh,{defval:''});
      }else{
        const text=await resp.text();
        return new Promise((res,rej)=>Papa.parse(text,{header:true,delimiter:text.includes(';')?';':',',skipEmptyLines:true,complete:o=>res(o.data),error:rej}));
      }
    }
    async function autoLoad(){
      for(const n of DATA_CANDIDATES){ try{ return {rows:await loadFromUrl(n), filename:n}; }catch(_){} }
      throw new Error(`No encontr√© ${DATA_CANDIDATES.join(' / ')} junto al HTML.`);
    }

    // IDs √∫nicos aunque la LICENCIA se repita
    function normRows(rows){
      const out=[]; let rowIdx=0;
      const licCounter = Object.create(null);

      for(const row of rows){
        const n={}; for(const k of Object.keys(row)) n[normalizeKey(k)]=row[k];

        const licencia = String(pick(n, ['licencia'], ['licencia'])).trim();
        const periodo  = String(pick(n, ['periodo'], ['periodo'])).trim();
        const titular  = String(pick(n, [
          'apellidos_y_nombres_/_razon_social',
          'apellidos_y_nombres/_razon_social',
          'apellidos_y_nombres_razon_social',
          'apellidos_y_nombres',
          'razon_social','titular','nombres_y_apellidos'
        ], ['apellidos','nombres','razon','social'])).trim();
        const ruc      = String(pick(n, ['r_u_c_','ruc','r.u.c.','r_u_c'], ['r','u','c'])).trim();
        const dir      = String(pick(n, ['direccion_del_establecimiento_comercial','direccion'], ['direccion','establecimiento','comercial'])).trim();
        const num      = String(pick(n, ['n¬∞','n','numero'], ['n'])).trim();
        const mz       = String(pick(n, ['mz.','mz'], ['mz'])).trim();
        const lt       = String(pick(n, ['lt.','lt'], ['lt'])).trim();
        const sector   = String(pick(n, ['sector'], ['sector'])).trim();
        const giro     = String(pick(n, ['giro_del_establecimiento','giro'], ['giro'])).trim();
        const nombreCom= String(pick(n, ['nombre_comercial'], ['nombre','comercial'])).trim();

        let lat = parseFloat(pick(n, ['lat'], ['lat']));
        let lng = parseFloat(pick(n, ['long','lng'], ['long','lng']));
        if(!Number.isFinite(lat)||!Number.isFinite(lng)){
          const p=parseUbicacion(pick(n, ['ubicacion'], ['ubicacion'])); lat=p.lat; lng=p.lng;
        }

        const anio = parseYear(periodo);

        let uid;
        if (licencia) {
          licCounter[licencia] = (licCounter[licencia] || 0) + 1;
          uid = `${licencia}#${licCounter[licencia]}`;
        } else {
          uid = (ruc || nombreCom || giro) ? `${ruc}|${nombreCom}|${giro}|${++rowIdx}` : String(++rowIdx);
        }

        out.push({
          id: uid, licencia, periodo, anio,
          titular, ruc, dir, num, mz, lt, sector, giro,
          nombre_comercial:nombreCom,
          lat: Number.isFinite(lat)?lat:null, lng: Number.isFinite(lng)?lng:null
        });
      }
      return out;
    }

    /* ===== Export KML/KMZ (agrupado por A√ëO) ===== */
    const toHex=n=>n.toString(16).padStart(2,'0');
    function hexToKml(hex){ const h=hex.replace('#',''); const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16); return `ff${toHex(b)}${toHex(g)}${toHex(r)}`; }
    const styleYearId = y => `y_${y}`;

    function buildKmlGroupedByYear(data){
      const groups = new Map(); // year -> array
      data.forEach(a=>{
        const y = a.anio ?? 'Sin a√±o';
        if(!groups.has(y)) groups.set(y, []);
        groups.get(y).push(a);
      });

      // styles por a√±o
      const styles = Array.from(groups.keys()).map(y=>{
        const col = colorForYear(y==='Sin a√±o' ? null : y);
        return `
        <Style id="${styleYearId(y)}">
          <IconStyle><color>${hexToKml(col)}</color><scale>1.2</scale></IconStyle>
          <LabelStyle><scale>0.0</scale></LabelStyle>
        </Style>`;
      }).join('\n');

      const folders = Array.from(groups.entries()).sort(([a],[b])=>{
        // 'Sin a√±o' al final
        if(a==='Sin a√±o') return 1;
        if(b==='Sin a√±o') return -1;
        return Number(a)-Number(b);
      }).map(([y,arr])=>{
        const placemarks = arr.filter(a=>Number.isFinite(a.lat)&&Number.isFinite(a.lng)).map(a=>`
          <Placemark>
            <name>${esc(displayName(a) || a.licencia || '')}</name>
            <styleUrl>#${styleYearId(y)}</styleUrl>
            <description><![CDATA[
              <b>A√±o:</b> ${a.anio ?? '-'}<br/>
              <b>Licencia:</b> ${esc(a.licencia)}<br/>
              <b>Periodo:</b> ${esc(a.periodo)}<br/>
              <b>Titular:</b> ${esc(a.titular)}<br/>
              <b>RUC:</b> ${esc(a.ruc)}<br/>
              <b>Direcci√≥n:</b> ${esc(a.dir)} ${a.num?('N¬∞ '+esc(a.num)) : ''} ${a.mz?(' MZ. '+esc(a.mz)) : ''} ${a.lt?(' LT. '+esc(a.lt)) : ''}<br/>
              <b>Sector:</b> ${esc(a.sector)}<br/>
              <b>Giro:</b> ${esc(a.giro)}
            ]]></description>
            <Point><coordinates>${a.lng},${a.lat},0</coordinates></Point>
          </Placemark>`).join('\n');
        return `<Folder><name>${y}</name>${placemarks}</Folder>`;
      }).join('\n');

      return `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Negocios ‚Äî Pachac√°mac (Agrupado por A√±o)</name>
    ${styles}
    ${folders}
  </Document>
</kml>`;
    }
    function downloadBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); setTimeout(()=>URL.revokeObjectURL(a.href), 1500); }

    /* ===== Tema ===== */
    function applyThemeUI(th){ const i=document.getElementById('themeIcon'), t=document.getElementById('themeText'); if(th==='dark'){i.textContent='‚òÄÔ∏è'; t.textContent='Modo claro';} else {i.textContent='üåô'; t.textContent='Modo oscuro';} }
    const mapIdForTheme = th => th==='dark' ? (MAP_ID_DARK||null) : (MAP_ID_LIGHT||null);
    function setTheme(th){ document.documentElement.setAttribute('data-theme', th); localStorage.setItem('prefers-theme-negocios', th); applyThemeUI(th); if(map){ const mid=mapIdForTheme(th); if(mid) map.setOptions({mapId:mid}); renderMarkers(applyFilters()); } }

    /* ===== Editor ===== */
    const getSelectedRecord = ()=> { const id=String(selectedId); if(!id) return null; return allData.find(a=>String(a.id)===id)||null; };
    function setCoordPreview(lat,lng){ const el=document.getElementById('coordPreview'); el.textContent=(Number.isFinite(lat)&&Number.isFinite(lng))?`Lat: ${lat.toFixed(6)} , Lng: ${lng.toFixed(6)}`:'Lat: ‚Äî , Lng: ‚Äî'; }

    function labelForOption(a, has){
      const name = displayName(a);
      const fallback = name || a.giro || a.sector || a.dir || '‚Äî';
      const lic = a.licencia || '(s/lic)';
      const year = a.anio ? ` ¬∑ ${a.anio}` : '';
      const tag = has ? '‚úÖ' : '‚ùå';
      return `${tag} ${lic}${year} ‚Äî ${fallback}`;
    }

    function rebuildPersonSelect(filterText=""){
      lastEditorFilter = filterText;
      const sectorNow = currentSector();
      const yearNow = currentYear();
      const sel=document.getElementById('personSelect');

      let entries = allData.slice();
      if (sectorNow !== 'todos') {
        entries = entries.filter(a => String(a.sector).toLowerCase() === String(sectorNow).toLowerCase());
      }
      if (yearNow !== 'todos') {
        entries = entries.filter(a => String(a.anio) === String(yearNow));
      }

      const f = filterText.trim().toLowerCase();
      if (f) {
        entries = entries.filter(a => {
          const licencia = String(a.licencia||'').toLowerCase();
          const nombre   = String(displayName(a)||'').toLowerCase();
          return licencia.includes(f) || nombre.includes(f);
        });
      }

      entries.sort((a,b)=> (displayName(a)||a.licencia||'').localeCompare((displayName(b)||b.licencia||''),'es'));

      const sin=entries.filter(a=>!(Number.isFinite(a.lat)&&Number.isFinite(a.lng)));
      const con=entries.filter(a=>(Number.isFinite(a.lat)&&Number.isFinite(a.lng)));

      sel.innerHTML='<option value="">Selecciona negocio‚Ä¶</option>';
      if(sin.length){ const g=document.createElement('optgroup'); g.label=`Sin ubicaci√≥n (${sin.length})`; sin.forEach(a=>{ const o=document.createElement('option'); o.value=a.id; o.textContent=labelForOption(a,false); g.appendChild(o); }); sel.appendChild(g); }
      if(con.length){ const g=document.createElement('optgroup'); g.label=`Con ubicaci√≥n (${con.length})`; con.forEach(a=>{ const o=document.createElement('option'); o.value=a.id; o.textContent=labelForOption(a,true); g.appendChild(o); }); sel.appendChild(g); }
    }

    function enableAssignMode(){
      if(assignMode) return;
      if(!selectedId){ alert('Selecciona un negocio.'); return; }
      assignMode=true; document.getElementById('btnAssign').textContent='‚úÖ Click en el mapa‚Ä¶'; document.body.style.cursor='crosshair';
      mapClickListener = map.addListener('click', (e)=>{
        const rec=getSelectedRecord(); if(!rec) return;
        const lat=e.latLng.lat(), lng=e.latLng.lng(); rec.lat=lat; rec.lng=lng; setCoordPreview(lat,lng);
        assignMode=false; document.getElementById('btnAssign').textContent='üìå Asignar en el mapa'; document.body.style.cursor='default';
        if(mapClickListener){ google.maps.event.removeListener(mapClickListener); mapClickListener=null; }
        rebuildPersonSelect(lastEditorFilter); document.getElementById('personSelect').value=String(rec.id);
        refresh();
        toast('Ubicaci√≥n asignada.');
      });
    }
    function centerOnSelected(){ const r=getSelectedRecord(); if(!r){ alert('Selecciona un negocio.'); return; } if(Number.isFinite(r.lat)&&Number.isFinite(r.lng)){ map.setCenter({lat:r.lat,lng:r.lng}); map.setZoom(17); } else { map.setCenter(CENTER); map.setZoom(14); } }
    function clearLocation(){ const r=getSelectedRecord(); if(!r){ alert('Selecciona un negocio.'); return; } r.lat=null; r.lng=null; setCoordPreview(null,null); rebuildPersonSelect(lastEditorFilter); document.getElementById('personSelect').value=String(r.id); refresh(); }

    function toExportRows(){
      return allData.map(a=>({
        'LICENCIA': a.licencia||'','PERIODO': a.periodo||'','APELLIDOS Y NOMBRES / RAZON SOCIAL': a.titular||'',
        'R.U.C.': a.ruc||'','DIRECCION DEL ESTABLECIMIENTO COMERCIAL': a.dir||'','N¬∞': a.num||'','MZ.': a.mz||'','LT.': a.lt||'',
        'SECTOR': a.sector||'','GIRO DEL ESTABLECIMIENTO': a.giro||'','NOMBRE COMERCIAL': a.nombre_comercial||'',
        'Lat': Number.isFinite(a.lat)?a.lat:'','Long': Number.isFinite(a.lng)?a.lng:''
      }));
    }
    function downloadXlsx(){
      const rows=toExportRows();
      const headers=['LICENCIA','PERIODO','APELLIDOS Y NOMBRES / RAZON SOCIAL','R.U.C.','DIRECCION DEL ESTABLECIMIENTO COMERCIAL','N¬∞','MZ.','LT.','SECTOR','GIRO DEL ESTABLECIMIENTO','NOMBRE COMERCIAL','Lat','Long'];
      const ws=XLSX.utils.json_to_sheet(rows,{header:headers});
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Negocios'); XLSX.writeFile(wb,'negocios_actualizado.xlsx');
    }
    function downloadCsv(){
      const rows=toExportRows();
      const headers=['LICENCIA','PERIODO','APELLIDOS Y NOMBRES / RAZON SOCIAL','R.U.C.','DIRECCION DEL ESTABLECIMIENTO COMERCIAL','N¬∞','MZ.','LT.','SECTOR','GIRO DEL ESTABLECIMIENTO','NOMBRE COMERCIAL','Lat','Long'];
      const lines=[headers.join(';')];
      for(const r of rows){
        const vals=headers.map(h=>{ const s=String(r[h]??'').replace(/"/g,'""'); return /[;\n"]/.test(s)?`"${s}"`:s; });
        lines.push(vals.join(';'));
      }
      const csv='\uFEFF'+lines.join('\n'); downloadBlob('negocios_actualizado.csv', new Blob([csv],{type:'text/csv;charset=utf-8;'}));
    }

    /* ===== Init ===== */
    window.initMap = async function(){
      // Tema inicial
      setTheme(localStorage.getItem('prefers-theme-negocios') || 'light');

      if(!(window.google && google.maps)){ alert('No carg√≥ Google Maps. Revisa API key / referrers.'); return; }
      map=new google.maps.Map(document.getElementById('map'), { center:CENTER, zoom:13, mapTypeControl:false, streetViewControl:false, fullscreenControl:true, mapId:(theme()==='dark'?MAP_ID_DARK:MAP_ID_LIGHT)||undefined });
      infoWindow=new google.maps.InfoWindow();

      // Tema toggle
      document.getElementById('themeToggle').addEventListener('click', ()=>{ setTheme(theme()==='dark'?'light':'dark'); });

      // Filtros principales
      document.getElementById('sectorFilter').addEventListener('change', ()=>{ refresh(); if (editMode) rebuildPersonSelect(lastEditorFilter); });
      document.getElementById('yearFilter').addEventListener('change', ()=>{ refresh(); if (editMode) rebuildPersonSelect(lastEditorFilter); });
      document.getElementById('searchInput').addEventListener('input', refresh);

      // Editor
      document.getElementById('toggleEdit').addEventListener('click', ()=>{
        editMode=!editMode; document.getElementById('editPanel').style.display=editMode?'flex':'none';
        if(!editMode && assignMode && mapClickListener){ google.maps.event.removeListener(mapClickListener); mapClickListener=null; assignMode=false; document.body.style.cursor='default'; }
        if(editMode){ rebuildPersonSelect(lastEditorFilter); }
      });

      // Subfiltro del editor
      const editorInput = document.getElementById('editorFilter');
      editorInput.addEventListener('input', (e)=>{ rebuildPersonSelect(e.target.value||''); });
      editorInput.addEventListener('keydown', (e)=>{
        if(e.key==='Enter'){
          const lic = (e.target.value||'').trim();
          if(!lic) return;
          rebuildPersonSelect(lic);
          const matches = allData.filter(a =>
            String(a.licencia||'').toLowerCase() === lic.toLowerCase() &&
            (currentSector()==='todos' || String(a.sector).toLowerCase()===String(currentSector()).toLowerCase()) &&
            (currentYear()==='todos' || String(a.anio)===String(currentYear()))
          );
          if(matches.length>1) toast(`Se encontraron ${matches.length} con licencia ${lic}. Elige uno.`, true);
          if(matches.length===1){ selectedId = matches[0].id; document.getElementById('personSelect').value = selectedId; setCoordPreview(matches[0].lat,matches[0].lng); }
        }
      });

      document.getElementById('personSelect').addEventListener('change', (e)=>{ selectedId=e.target.value||''; const rec=getSelectedRecord(); if(rec&&Number.isFinite(rec.lat)&&Number.isFinite(rec.lng)) setCoordPreview(rec.lat,rec.lng); else setCoordPreview(null,null); });
      document.getElementById('btnAssign').addEventListener('click', enableAssignMode);
      document.getElementById('btnCenter').addEventListener('click', centerOnSelected);
      document.getElementById('btnClear').addEventListener('click', clearLocation);
      document.getElementById('btnExportXlsx').addEventListener('click', downloadXlsx);
      document.getElementById('btnExportCsv').addEventListener('click', downloadCsv);

      // Export
      document.getElementById('btnKml').addEventListener('click', ()=>{
        const only=document.getElementById('onlyVisible').checked;
        const data=(only?applyFilters():allData).filter(a=>Number.isFinite(a.lat)&&Number.isFinite(a.lng));
        if(!data.length) return toast('No hay datos para exportar', false);
        const kml=buildKmlGroupedByYear(data); downloadBlob('negocios_pachacamac.kml', new Blob([kml],{type:'application/vnd.google-earth.kml+xml'}));
      });
      document.getElementById('btnKmz').addEventListener('click', async ()=>{
        const only=document.getElementById('onlyVisible').checked;
        const data=(only?applyFilters():allData).filter(a=>Number.isFinite(a.lat)&&Number.isFinite(a.lng));
        if(!data.length) return toast('No hay datos para exportar', false);
        const zip=new JSZip(); zip.file('doc.kml', buildKmlGroupedByYear(data)); const blob=await zip.generateAsync({type:'blob'}); downloadBlob('negocios_pachacamac.kmz', blob);
      });

      // FAB offset
      adjustFabOffset(); new ResizeObserver(adjustFabOffset).observe(document.getElementById('exportBar')); window.addEventListener('resize', adjustFabOffset);

      // Datos
      try{
        toast('Cargando datos‚Ä¶');
        const {rows, filename}=await autoLoad();
        allData = normRows(rows);
        populateFilters();
        rebuildPersonSelect('');
        refresh();
        toast(`Dataset: ${filename} (${allData.length} filas)`);
      }catch(err){ toast(err.message, false); }
    };
  </script>

  <!-- Google Maps) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDfZXJcPZHOEW_pdzEhOEdq17d4kBY3oT8&callback=initMap&v=weekly&loading=async&libraries=marker" defer></script>
</body>
</html>




























































