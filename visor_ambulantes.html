<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visor ‚Äî Ambulantes (Pachac√°mac)</title>

  <style>
    :root{
      --brand:#1a73e8;
      --ink:#0f172a;
      --muted:#667085;
      --bg:#f6f7f9;
      --card:#ffffff;
      --ring:#e5e7eb;
      --chip:#f3f4f6;
    }
    [data-theme="dark"]{
      --brand:#60a5fa;
      --ink:#e5e7eb;
      --muted:#9aa4b2;
      --bg:#0b1220;
      --card:#0f172a;
      --ring:#1f2937;
      --chip:#111827;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,system-ui,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      transition: background .25s, color .25s;
    }

    .hero{
      position:sticky; top:0; z-index:20;
      background: radial-gradient(1200px 600px at 10% -20%, rgba(232,240,254,.7) 10%, transparent 60%), var(--card);
      border-bottom:1px solid var(--ring);
      padding:18px 20px 12px 20px;
      display:flex; flex-direction:column; gap:6px; align-items:center; text-align:center;
    }
    [data-theme="dark"] .hero{
      background: radial-gradient(1200px 600px at 10% -20%, rgba(37,99,235,.25) 8%, transparent 60%), var(--card);
    }
    .hero h1{
      margin:0; font-size:22px; font-weight:800; letter-spacing:.2px;
      color:var(--brand); display:flex; gap:8px; align-items:center;
    }
    .hero h1 .dot{width:8px;height:8px;border-radius:999px;background:var(--brand);box-shadow:0 0 0 4px rgba(26,115,232,.15)}
    .hero p{margin:0;color:var(--muted);font-size:14px}
    .badge{
      margin-top:6px;
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      background:var(--chip); border:1px solid var(--ring);
      font-size:12px; color:var(--muted);
    }

    .theme{
      position: fixed;
      right: 16px;
      top: 12px;
      z-index: 10000;
      pointer-events: auto;
    }
    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid var(--ring); background:#fff; cursor:pointer;
      font-weight:600; transition: box-shadow .25s, transform .08s, background .2s, border-color .2s, color .25s;
      color:#111827;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
    }
    [data-theme="dark"] .btn{ background:#0b1324; color:#e5e7eb; border-color:#223049 }
    .btn:hover{box-shadow:0 10px 28px rgba(26,115,232,.18)}
    .btn:active{transform:translateY(1px)}

    .controls{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background:rgba(255,255,255,.75); backdrop-filter: blur(8px);
      padding:10px 14px; margin:8px 12px; border:1px solid var(--ring);
      border-radius:14px; box-shadow:0 4px 24px rgba(0,0,0,.06);
      transition: box-shadow .25s, transform .2s, background .25s;
    }
    [data-theme="dark"] .controls{ background:rgba(15,23,42,.75) }
    .controls:hover{box-shadow:0 8px 30px rgba(0,0,0,.09)}
    .controls .group{display:flex;gap:8px;align-items:center}
    label{font-weight:600;color:#334155;font-size:14px}
    [data-theme="dark"] label{color:#cbd5e1}
    select,input{
      padding:9px 12px;border:1px solid var(--ring);border-radius:10px;background:#fff;color:#111827;
      transition:border-color .2s, box-shadow .2s, transform .08s, background .25s, color .25s;
    }
    [data-theme="dark"] select,[data-theme="dark"] input{background:#0b1324;color:#e5e7eb;border-color:#223049}
    select:focus,input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(26,115,232,.18)}
    .search{min-width:260px}

    .stats{display:flex; gap:10px; align-items:center; padding:0 14px 8px 14px; flex-wrap:wrap}
    .chip{
      display:inline-flex; gap:6px; align-items:center;
      background:var(--chip); border:1px solid var(--ring); color:#1f2937;
      padding:6px 10px;border-radius:999px;font-size:13px;
    }
    [data-theme="dark"] .chip{ color:#e5e7eb }
    .chip b{color:var(--brand)}

    #map{
      height:62vh; min-height:520px; width:100%;
      border-top:1px solid var(--ring); border-bottom:1px solid var(--ring);
      background:#eef2ff;
    }

    .legend-dock{
      position:relative; background:var(--card);
      border-top:1px solid var(--ring);
      padding:10px 14px; display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;
      transition: background .25s;
    }
    .legend-block h3{margin:0 0 8px 0;font-size:14px;color:#334155}
    [data-theme="dark"] .legend-block h3{ color:#cbd5e1 }
    .legend-items{display:flex; gap:12px; flex-wrap:wrap}
    .legend-item{
      display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--ring);
      background:#fff; border-radius:999px; font-size:13px;
      transition:transform .15s, box-shadow .2s, background .25s, color .25s;
      cursor:pointer; user-select:none;
    }
    [data-theme="dark"] .legend-item{ background:#0b1324; color:#e5e7eb }
    .legend-item:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.06)}
    .legend-dot{width:14px;height:14px;border-radius:999px;box-shadow:0 0 0 3px #fff, 0 1px 0 rgba(0,0,0,.1)}
    [data-theme="dark"] .legend-dot{ box-shadow:0 0 0 2px #0b1324, 0 1px 0 rgba(0,0,0,.4) }
    .legend-ring{width:14px;height:14px;border-radius:999px;background:#fff;border:3px solid #000;box-shadow:0 1px 0 rgba(0,0,0,.1)}

    .map-fabs{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .fab{
      background:#fff; border:1px solid var(--ring); border-radius:10px;
      padding:8px 10px; font-weight:600; cursor:pointer;
      box-shadow:0 8px 26px rgba(0,0,0,.10);
      transition: transform .12s, box-shadow .2s, background .25s, color .25s;
      color:#111827;
    }
    [data-theme="dark"] .fab{ background:#0b1324; color:#e5e7eb; border-color:#223049 }
    .fab:hover{ transform:translateY(-1px); box-shadow:0 12px 32px rgba(0,0,0,.14); }

    .toast{
      position:fixed; right:16px; top:16px; z-index:40;
      background:#0ea5e9; color:#fff; border-radius:12px; padding:10px 14px; font-size:13px;
      box-shadow:0 12px 30px rgba(2,132,199,.4); transform:translateY(-10px); opacity:0;
      transition: opacity .25s, transform .25s;
    }
    .toast.show{opacity:1; transform:none}

    .marker-node svg{ filter: drop-shadow(0 2px 0 rgba(0,0,0,.08)); transition: transform .12s ease, filter .2s ease; }
    .marker-node:hover svg{ transform: scale(1.06); filter: drop-shadow(0 6px 12px rgba(0,0,0,.18)); }

    [data-theme="dark"] .gm-style .gm-style-iw-c{
      background:#0b1324 !important; color:#e5e7eb !important; border-radius:12px;
    }
    [data-theme="dark"] .gm-style .gm-style-iw-d{ color:#e5e7eb !important; }
    [data-theme="dark"] .gm-style .gm-style-iw-d a{ color:#60a5fa !important; }
    [data-theme="dark"] .gm-style .gm-style-iw-t::after{ background:#0b1324 !important; }

    @media (max-width: 640px){
      .controls{ margin:8px 8px }
      .stats{ padding:0 8px 8px 8px }
      .theme{ right: 10px; top: 10px }
      .map-fabs{ right: 12px }
    }
  </style>
</head>

<body>
  <div class="hero">
    <h1><span class="dot"></span> Visor de Ambulantes Formales</h1>
    <p>Distrito de <b>Pachac√°mac</b> ‚Äî vista solo lectura</p>
    <span class="badge">üîí Solo lectura ‚Ä¢ Sin edici√≥n ‚Ä¢ Sin descargas</span>
  </div>

  <div class="theme">
    <button id="themeToggle" class="btn"><span id="themeIcon">üåô</span> <span id="themeText">Modo oscuro</span></button>
  </div>

  <div class="controls">
    <div class="group">
      <label>üè∑Ô∏è Rubro</label>
      <select id="giroFilter"><option value="todos">Todos</option></select>
    </div>
    <div class="group">
      <label>üïê Turno</label>
      <select id="turnoFilter">
        <option value="todos">Todos</option>
        <option value="manana">Ma√±ana</option>
        <option value="tarde">Tarde</option>
      </select>
    </div>
    <div class="group" style="flex:1;min-width:260px">
      <label>üîé Buscar</label>
      <input id="searchInput" class="search" placeholder="Nombre, productos, zona‚Ä¶"/>
    </div>
  </div>

  <div class="stats">
    <span class="chip">üë• Total: <b id="totalCount">0</b></span>
    <span class="chip">üìç Mostrando: <b id="visibleCount">0</b></span>
    <span class="chip">üè™ Zonas activas: <b id="activeZones">0</b></span>
  </div>

  <div id="map"></div>

  <div class="map-fabs">
    <button class="fab" id="btnReset">‚Ü∫ Reset filtros</button>
    <button class="fab" id="btnLoc">üìç Mi ubicaci√≥n</button>
  </div>

  <div class="legend-dock">
    <div class="legend-block" style="min-width:220px">
      <h3>Leyenda por Rubro (color de relleno)</h3>
      <div id="legendGiros" class="legend-items"></div>
    </div>
    <div class="legend-block">
      <h3>Leyenda por turno (borde)</h3>
      <div class="legend-items">
        <div class="legend-item"><span class="legend-ring" style="border-color:#f59e0b"></span> üåÖ Ma√±ana</div>
        <div class="legend-item"><span class="legend-ring" style="border-color:#6366f1"></span> üåÜ Tarde</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Cargando datos‚Ä¶</div>

  <!-- Libs (solo lectura: cargar XLSX/CSV) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* ==================== Config ==================== */
    const DATA_CANDIDATES = [
      "ambulantes_actualizado.xlsx","ambulantes_actualizado.csv",
      "ambulantes.xlsx","ambulantes.csv"
    ];

    const MAP_ID_LIGHT = "REEMPLAZA_CON_TU_MAP_ID_CLARO";
    const MAP_ID_DARK  = "REEMPLAZA_CON_TU_MAP_ID_OSCURO";

    const PACHACAMAC_CENTER = { lat: -12.155, lng: -76.870 };

    /* ==================== Estado ==================== */
    let map, infoWindow, markers=[];
    let allData=[];

    /* ==================== Utils ==================== */
    const normalizeKey = s => String(s||'')
      .toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .trim().replace(/\s+/g,'_');

    const esc = t => String(t??'')
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    const theme = () => document.documentElement.getAttribute('data-theme') || 'light';

    function toast(msg, ok=true){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.background = ok ? '#0ea5e9' : '#ef4444';
      el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'), 2300);
    }

    function parseUbicacion(val){
      if(!val) return {lat:null,lng:null};
      const txt=String(val).replace(/\s+/g,''); const [la,ln]=txt.split(',');
      const lat=parseFloat(la), lng=parseFloat(ln);
      return {lat:Number.isFinite(lat)?lat:null, lng:Number.isFinite(lng)?lng:null};
    }

    function normalizeTurno(v){
      const k=String(v||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      if(k.includes('tarde')) return 'tarde';
      if(k.includes('manana')||k.includes('ma√±ana')) return 'manana';
      return '';
    }

    /* ===== Colores por giro ===== */
    const normGiro = g => String(g||'').trim().toLowerCase();
    const OVERRIDE_COLORS = { 'asedipa': '#22c55e' };
    const PALETTE_HEX = [
      '#2563eb','#8b5cf6','#ef4444','#f59e0b','#06b6d4','#f472b6','#a855f7','#eab308',
      '#fb7185','#14b8a6','#0ea5e9','#94a3b8','#f97316','#84cc16','#38bdf8','#d946ef',
      '#10b981','#dc2626','#7c3aed','#3b82f6','#f43f5e','#22d3ee','#9333ea','#ca8a04',
      '#0891b2','#4f46e5','#65a30d','#ea580c','#0284c7'
    ].filter((v,i,arr)=>arr.indexOf(v)===i);

    let GIRO_COLOR_MAP = {};

    function hslToRgb(h, s, l){
      s/=100; l/=100;
      const k=n=>(n+h/30)%12, a=s*Math.min(l,1-l);
      const f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1)));
      return [Math.round(255*f(0)),Math.round(255*f(8)),Math.round(255*f(4))];
    }
    function rgbToHex(r,g,b){
      const to=n=>n.toString(16).padStart(2,'0');
      return `#${to(r)}${to(g)}${to(b)}`;
    }
    function hslToHex(h,s,l){
      const [r,g,b]=hslToRgb(h,s,l);
      return rgbToHex(r,g,b);
    }

    function buildGiroColorMap(giros){
      GIRO_COLOR_MAP = {};
      const used = new Set(Object.values(OVERRIDE_COLORS).map(c=>c.toLowerCase()));
      giros.forEach(g=>{ const k=normGiro(g); if(OVERRIDE_COLORS[k]) GIRO_COLOR_MAP[k]=OVERRIDE_COLORS[k]; });
      let pi=0, gen=0;

      giros.forEach(g=>{
        const k=normGiro(g);
        if(!k || GIRO_COLOR_MAP[k]) return;

        let hex;
        while(true){
          if(pi<PALETTE_HEX.length){ hex = PALETTE_HEX[pi++]; }
          else { const hue=(gen*137.508)%360; gen++; hex = hslToHex(hue,70,50); }
          if(!used.has(hex.toLowerCase()) && hex.toLowerCase()!=='#22c55e') break;
        }
        used.add(hex.toLowerCase());
        GIRO_COLOR_MAP[k]=hex;
      });
    }

    const colorForGiro = g => GIRO_COLOR_MAP[normGiro(g)] || '#64748b';
    const strokeForTurno = t => (t==='tarde' ? '#6366f1' : '#f59e0b');

    function popupHtml(a){
      return `
      <div style="min-width:260px;max-width:360px;font-family:inherit">
        <div style="background:#1a73e8;color:#fff;padding:10px;border-radius:6px 6px 0 0;margin:-8px -8px 8px -8px;font-weight:700">
          ${esc(a.nombre)}
        </div>
        <div><b>Giro:</b> ${esc(a.giro||'-')}</div>
        <div><b>Productos:</b> ${esc(a.productos||'-')}</div>
        <div><b>Zona:</b> ${esc(a.zona||'-')}</div>
        <div><b>Lugar exacto:</b> ${esc(a.lugar_exacto||'-')}</div>
        <div><b>Turno:</b> ${a.turno==='manana'?'Ma√±ana':'Tarde'}</div>
        <div><b>Horario:</b> ${esc(a.horario||'-')}</div>
        <div><b>Licencia:</b> ${esc(a.licencia||'-')}</div>
        <div><b>Vigencia:</b> ${esc(a.vigencia||'-')}</div>
      </div>`;
    }

    /* ==================== Mapa ==================== */
    function clearMarkers(){
      for(const m of markers) m.setMap && m.setMap(null);
      markers=[];
    }

    function renderMarkers(data){
      clearMarkers();
      const bounds = new google.maps.LatLngBounds();
      const hasAdv = !!(google.maps.marker && google.maps.marker.AdvancedMarkerElement);

      data.forEach(a=>{
        const pos = {lat:a.lat, lng:a.lng};

        if(hasAdv){
          const node = document.createElement('div');
          node.className = 'marker-node';
          node.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28" aria-hidden="true">
              <circle cx="14" cy="14" r="11" fill="${colorForGiro(a.giro)}" />
              <circle cx="14" cy="14" r="12.5" fill="none" stroke="${strokeForTurno(a.turno)}" stroke-width="3" />
            </svg>`;
          const mk = new google.maps.marker.AdvancedMarkerElement({ map, position:pos, title:a.nombre, content:node });
          mk.addListener('gmp-click', ()=>{
            infoWindow.setContent(popupHtml(a));
            infoWindow.open({anchor:mk,map});
          });
          markers.push(mk);
          bounds.extend(mk.position);
        } else {
          const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">
            <circle cx="14" cy="14" r="11" fill="${colorForGiro(a.giro)}" />
            <circle cx="14" cy="14" r="12.5" fill="none" stroke="${strokeForTurno(a.turno)}" stroke-width="3" />
          </svg>`;
          const mk = new google.maps.Marker({
            map, position:pos, title:a.nombre,
            icon: {
              url:'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(svg),
              scaledSize:new google.maps.Size(28,28),
              anchor:new google.maps.Point(14,14)
            }
          });
          mk.addListener('click', ()=>{
            infoWindow.setContent(popupHtml(a));
            infoWindow.open({anchor:mk,map});
          });
          markers.push(mk);
          bounds.extend(mk.getPosition());
        }
      });

      if(data.length) map.fitBounds(bounds, 60);
      else { map.setCenter(PACHACAMAC_CENTER); map.setZoom(13); }
    }

    /* ==================== Filtros/UI ==================== */
    function applyFilters(){
      const giro = document.getElementById('giroFilter').value;
      const turno = document.getElementById('turnoFilter').value;
      const q = document.getElementById('searchInput').value.trim().toLowerCase();

      return allData.filter(a=>{
        const gOk = (giro==='todos') || (String(a.giro).toLowerCase()===String(giro).toLowerCase());
        const tOk = (turno==='todos') || (a.turno===turno);
        const qOk = !q || [a.nombre,a.productos,a.zona,a.giro,a.lugar_exacto,a.horario,a.licencia,a.vigencia]
          .some(v=>String(v||'').toLowerCase().includes(q));
        return gOk && tOk && qOk;
      });
    }

    function updateStats(filtered){
      const zonas = [...new Set(filtered.map(a=>a.zona).filter(Boolean))];
      document.getElementById('totalCount').textContent = allData.length;
      document.getElementById('visibleCount').textContent = filtered.length;
      document.getElementById('activeZones').textContent = zonas.length;
    }

    function populateGiroFilterAndLegend(){
      const giros = [...new Set(allData.map(a=>a.giro).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'es'));
      buildGiroColorMap(giros);

      const sel = document.getElementById('giroFilter');
      sel.innerHTML = '<option value="todos">Todos</option>';
      giros.forEach(g=>{
        const opt=document.createElement('option');
        opt.value=g; opt.textContent=g;
        sel.appendChild(opt);
      });

      const cont = document.getElementById('legendGiros');
      cont.innerHTML='';
      giros.forEach(g=>{
        const item = document.createElement('div');
        item.className='legend-item';
        item.innerHTML = `<span class="legend-dot" style="background:${colorForGiro(g)}"></span> ${esc(g)}`;
        item.addEventListener('click', ()=>{
          document.getElementById('giroFilter').value = g;
          refresh();
        });
        cont.appendChild(item);
      });
    }

    function refresh(){
      const filtered = applyFilters();
      renderMarkers(filtered);
      updateStats(filtered);
    }

    /* ==================== Carga de datos ==================== */
    async function loadFromUrl(name){
      const resp = await fetch(name);
      if(!resp.ok) throw new Error('No se pudo cargar '+name);
      const low = name.toLowerCase();
      if(low.endsWith('.xlsx')||low.endsWith('.xls')){
        const wb = XLSX.read(await resp.arrayBuffer(),{type:'array'});
        const sh = wb.Sheets[wb.SheetNames[0]];
        return XLSX.utils.sheet_to_json(sh,{defval:''});
      } else {
        const text = await resp.text();
        return new Promise((res,rej)=>Papa.parse(text,{
          header:true,
          delimiter:text.includes(';')?';':',',
          skipEmptyLines:true,
          complete:o=>res(o.data),
          error:rej
        }));
      }
    }

    async function autoLoad(){
      for(const n of DATA_CANDIDATES){
        try{ return {rows: await loadFromUrl(n), filename:n}; }catch(_){}
      }
      throw new Error(`No encontr√© ${DATA_CANDIDATES.join(' / ')} junto al HTML.`);
    }

    function normalizeRows(rows){
      const out=[];
      for(const row of rows){
        const n={}; for(const k of Object.keys(row)) n[normalizeKey(k)] = row[k];

        let lat = parseFloat(n['lat']), lng = parseFloat(n['lng']);
        if(!Number.isFinite(lat)||!Number.isFinite(lng)){
          const p = parseUbicacion(n['ubicacion'] ?? n['ubicaciOn']);
          lat=p.lat; lng=p.lng;
        }

        let turno = normalizeTurno(n['turno']);
        if(!turno){
          const hh=String(n['horario']||'').toUpperCase();
          if(hh) turno = hh.includes('PM') ? 'tarde' : 'manana';
        }

        out.push({
          id: String(n['id']??''),
          nombre:String(n['nombre']??'').trim(),
          giro:String(n['giro']??'').trim(),
          productos:String(n['productos']??'').trim(),
          zona:String(n['zona']??'').trim(),
          lugar_exacto:String(n['lugar_exacto']??'').trim(),
          horario:String(n['horario']??'').trim(),
          licencia:String(n['licencia']??'').trim(),
          vigencia:String(n['vigencia']??'').trim(),
          turno: turno||'manana',
          lat: Number.isFinite(lat)?lat:null,
          lng: Number.isFinite(lng)?lng:null
        });
      }
      return out;
    }

    /* ==================== Tema ==================== */
    function applyThemeUI(th){
      const icon = document.getElementById('themeIcon');
      const text = document.getElementById('themeText');
      if(th==='dark'){ icon.textContent='‚òÄÔ∏è'; text.textContent='Modo claro'; }
      else { icon.textContent='üåô'; text.textContent='Modo oscuro'; }
    }
    function mapIdForTheme(th){ return th==='dark' ? (MAP_ID_DARK || null) : (MAP_ID_LIGHT || null); }
    function switchMapId(th){
      const mid = mapIdForTheme(th);
      if(mid){ map.setOptions({ mapId: mid }); }
    }
    function setTheme(th){
      document.documentElement.setAttribute('data-theme', th);
      localStorage.setItem('prefers-theme-visor-ambulantes', th);
      applyThemeUI(th);
      if(map) switchMapId(th);
    }

    /* ==================== Init ==================== */
    window.initMap = async function(){
      const saved = localStorage.getItem('prefers-theme-visor-ambulantes');
      setTheme(saved || 'light');

      if(!(window.google && google.maps)){
        alert('No carg√≥ Google Maps. Revisa tu API key / referrers.');
        return;
      }

      map = new google.maps.Map(document.getElementById('map'), {
        center: PACHACAMAC_CENTER,
        zoom:13,
        mapTypeControl:false,
        streetViewControl:false,
        fullscreenControl:true,
        mapId: mapIdForTheme(theme()) || undefined
      });
      infoWindow = new google.maps.InfoWindow();

      // Toggle tema
      document.getElementById('themeToggle').addEventListener('click', ()=>{
        setTheme(theme()==='dark' ? 'light' : 'dark');
      });

      // Filtros
      document.getElementById('giroFilter').addEventListener('change', refresh);
      document.getElementById('turnoFilter').addEventListener('change', refresh);
      document.getElementById('searchInput').addEventListener('input', refresh);

      // FABs
      document.getElementById('btnReset').addEventListener('click', ()=>{
        document.getElementById('giroFilter').value = 'todos';
        document.getElementById('turnoFilter').value = 'todos';
        document.getElementById('searchInput').value = '';
        refresh();
      });

      document.getElementById('btnLoc').addEventListener('click', ()=>{
        if(!navigator.geolocation){ toast('Geolocalizaci√≥n no disponible', false); return; }
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude:lat, longitude:lng} = pos.coords;
          map.panTo({lat,lng}); map.setZoom(16);
        }, ()=>toast('No se pudo obtener tu ubicaci√≥n', false), {enableHighAccuracy:true,timeout:8000,maximumAge:0});
      });

      // Datos
      try{
        toast('Cargando datos‚Ä¶');
        const {rows, filename} = await autoLoad();

        // SOLO LECTURA: nos quedamos con los que ya tienen coordenadas
        allData = normalizeRows(rows).filter(a => Number.isFinite(a.lat) && Number.isFinite(a.lng));

        toast(`Cargado: ${filename} (${allData.length} puntos)`);
        populateGiroFilterAndLegend();
        refresh();
      }catch(err){
        toast(err.message, false);
      }
    };
  </script>

  <!-- Google Maps JS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRBvdy3NXKU7iJoRrh7CBJI-5fwa1N7D0&callback=initMap&v=weekly&loading=async&libraries=marker" defer></script>
</body>
</html>
